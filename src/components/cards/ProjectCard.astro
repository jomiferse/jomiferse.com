---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";

export interface Project {
	title: string;
	role: string;
	companyRelated?: string;
	context?: string;
	timeframe?: string;
	technologies: string[];
	summary: string;
	highlights?: string[];
	link?: string;

	img?: {
		imgStatic?: { src: string; alt?: string };
		imgHover?: { src: string; alt?: string };
	};
}

interface Props {
	project: Project;
}

const { project } = Astro.props;

const dialogId =
	"project-" +
	project.title
		.toLowerCase()
		.trim()
		.replace(/[^a-z0-9]+/g, "-")
		.replace(/(^-|-$)/g, "");

const staticSrc = project.img?.imgStatic?.src;
const hoverSrc = project.img?.imgHover?.src;
const baseSrc = staticSrc ?? hoverSrc;
---

<div
	role="button"
	tabindex="0"
	class="group block w-full cursor-pointer text-left focus:outline-none"
	aria-haspopup="dialog"
	aria-controls={dialogId}
	onclick={`document.getElementById('${dialogId}')?.showModal()`}
	onkeydown={`if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); document.getElementById('${dialogId}')?.showModal(); }`}
>
	<article
		class="relative overflow-hidden rounded-4xl border border-slate-200/80 bg-white/70 shadow-sm backdrop-blur transition-all duration-300
		hover:-translate-y-0.5 hover:border-purple-500/30 hover:bg-white/80
		focus-visible:ring-2 focus-visible:ring-purple-500/40
		dark:border-zinc-800 dark:bg-zinc-900/40 dark:hover:border-purple-500/40 dark:hover:bg-zinc-950/55"
	>
		<div class="relative aspect-4/3 w-full overflow-hidden rounded-t-4xl">
			{
				baseSrc ? (
					<>
						<Image
							src={baseSrc}
							alt={project.img?.imgStatic?.alt ?? `Cover for ${project.title}`}
							width={640}
							height={480}
							loading="eager"
							quality={100}
							class="absolute inset-0 h-full w-full object-cover opacity-90"
						/>

						{hoverSrc && (
							<Image
								src={hoverSrc}
								alt={project.img?.imgHover?.alt ?? `Preview for ${project.title}`}
								width={640}
								height={480}
								loading="eager"
								quality={100}
								class="absolute inset-0 h-full w-full object-cover opacity-0 transition-opacity duration-200 group-hover:opacity-100"
							/>
						)}
					</>
				) : (
					<div class="h-full w-full bg-linear-to-br from-purple-500/20 via-sky-400/10 to-transparent" />
				)
			}

			<div class="absolute inset-0 opacity-0 transition group-hover:opacity-100">
				<div class="absolute inset-0 bg-purple-500/5"></div>
			</div>

			<div
				class="pointer-events-none absolute -inset-10 rounded-[48px] bg-[radial-gradient(closest-side,rgba(168,85,247,0.22),transparent)] opacity-70"
			></div>

			<div
				class="absolute right-4 bottom-4 grid h-10 w-10 place-items-center rounded-full bg-white/70 ring-1 ring-slate-200/80 backdrop-blur transition-all duration-300
				group-hover:bg-white/85 group-hover:ring-purple-500/30
				dark:bg-zinc-900/60 dark:ring-zinc-800/70 dark:group-hover:bg-zinc-900/80 dark:group-hover:ring-purple-500/40"
				aria-hidden="true"
			>
				<Icon name="plus" class="h-6 w-6 text-slate-700 dark:text-zinc-100" />
			</div>
		</div>

		<div class="px-5 pt-4 pb-5">
			<h3 class="text-lg font-semibold tracking-tight text-slate-900 md:text-xl dark:text-zinc-50">
				{project.title}
			</h3>

			<p class="mt-1 text-xs text-slate-600 dark:text-zinc-400">
				{
					project.companyRelated ? (
						<span class="text-purple-700 dark:text-purple-200/90">
							{project.companyRelated}
						</span>
					) : null
				}
				{project.companyRelated ? (
					<span class="text-slate-400 dark:text-zinc-600"> 路 </span>
				) : null}
				{project.role}
				{project.timeframe ? <span> 路 {project.timeframe}</span> : null}
			</p>

			<div class="mt-4 flex flex-wrap gap-2">
				{
					project.technologies.slice(0, 4).map((tech) => (
						<span class="inline-flex items-center rounded-full border border-purple-500/20 bg-purple-500/10 px-2.5 py-1 text-[11px] font-semibold text-purple-700
						dark:text-purple-200/90">
							{tech}
						</span>
					))
				}
				{
					project.technologies.length > 4 && (
						<span class="inline-flex items-center rounded-full border border-slate-200/80 bg-white/60 px-2.5 py-1 text-[11px] font-semibold text-slate-700
						dark:border-zinc-800/70 dark:bg-zinc-950/30 dark:text-zinc-300/90">
							+{project.technologies.length - 4}
						</span>
					)
				}
			</div>
		</div>
	</article>
</div>

<dialog
	id={dialogId}
	class="fixed inset-0 m-auto w-[min(720px,92vw)] rounded-[28px] border border-slate-200/80 bg-white/95 p-0 text-slate-900 shadow-xl
	dark:border-zinc-800/70 dark:bg-zinc-950/95 dark:text-zinc-100"
>
	<div class="overflow-hidden rounded-[28px]">
		<div class="border-b border-slate-200/80 p-5 md:p-6 dark:border-zinc-800/70">
			<div class="flex items-start justify-between gap-4">
				<div class="min-w-0">
					<h3 class="text-xl font-semibold tracking-tight text-slate-900 dark:text-zinc-50">
						{project.title}
					</h3>

					<p class="mt-1 text-sm text-slate-600 dark:text-zinc-400">
						{
							project.companyRelated ? (
								<span class="text-purple-700 dark:text-purple-200/90">
									{project.companyRelated}
								</span>
							) : null
						}
						{
							project.companyRelated ? (
								<span class="text-slate-400 dark:text-zinc-600"> 路 </span>
							) : null
						}
						{project.role}
						{project.timeframe ? <span> 路 {project.timeframe}</span> : null}
					</p>
				</div>

				<form method="dialog">
					<button
						class="grid h-10 w-10 cursor-pointer place-items-center rounded-full bg-slate-100/70 ring-1 ring-slate-200 transition hover:bg-slate-100
						dark:bg-zinc-900/50 dark:ring-zinc-800/70 dark:hover:bg-zinc-900/70"
						aria-label="Close dialog"
					>
						<Icon name="x" class="h-5 w-5 text-slate-700 dark:text-zinc-100" />
					</button>
				</form>
			</div>
		</div>

		<div class="space-y-5 p-5 md:p-6">
			{
				project.context && (
					<div>
						<p class="text-xs font-semibold tracking-[0.18em] text-slate-500 dark:text-zinc-500">
							CONTEXT
						</p>
						<p class="mt-2 text-sm leading-relaxed text-slate-700 dark:text-zinc-200/90">
							{project.context}
						</p>
					</div>
				)
			}

			<div>
				<p class="text-xs font-semibold tracking-[0.18em] text-slate-500 dark:text-zinc-500">
					SUMMARY
				</p>
				<p class="mt-2 text-sm leading-relaxed text-slate-700 dark:text-zinc-200/90">
					{project.summary}
				</p>
			</div>

			{
				project.highlights?.length ? (
					<div>
						<p class="text-xs font-semibold tracking-[0.18em] text-slate-500 dark:text-zinc-500">
							HIGHLIGHTS
						</p>
						<ul class="mt-2 space-y-2 text-sm text-slate-700 dark:text-zinc-200/90">
							{project.highlights.map((h) => (
								<li class="flex gap-2">
									<span class="mt-2 inline-block h-1.5 w-1.5 rounded-full bg-purple-500/80" />
									<span>{h}</span>
								</li>
							))}
						</ul>
					</div>
				) : null
			}

			<div>
				<p class="text-xs font-semibold tracking-[0.18em] text-slate-500 dark:text-zinc-500">
					TECHNOLOGIES
				</p>
				<div class="mt-2 flex flex-wrap gap-2">
					{
						project.technologies.map((tech) => (
							<span class="inline-flex items-center rounded-full border border-slate-200/80 bg-white px-2.5 py-1 text-[11px] font-semibold text-slate-700
							dark:border-zinc-800/70 dark:bg-zinc-950/30 dark:text-zinc-200">
								{tech}
							</span>
						))
					}
				</div>
			</div>

			{
				project.link && (
					<div class="pt-2">
						<a
							href={project.link}
							target="_blank"
							rel="noreferrer"
							class="inline-flex items-center gap-2 rounded-2xl bg-purple-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-purple-700"
						>
							View project
							<Icon name="move-up-right" class="h-4 w-4" />
						</a>
					</div>
				)
			}
		</div>
	</div>
</dialog>

<script is:inline>
	document.querySelectorAll("dialog").forEach((dialog) => {
		dialog.addEventListener("click", (e) => {
			if (e.target === dialog) dialog.close();
		});
	});
</script>
