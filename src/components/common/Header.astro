---
import { Icon } from "astro-icon/components";
import ThemeToggle from "@/components/common/ThemeToggle.astro";
import LanguageToggle from "@/components/common/LanguageToggle.astro";
import { t, type Locale } from "@/i18n";

interface NavLink {
	href: string;
	labelKey: string;
}

const { locale } = Astro.props as { locale: Locale };

const links: NavLink[] = [
	{ href: "/", labelKey: "nav.home" },
	{ href: "/projects", labelKey: "nav.projects" },
	{ href: "/experience", labelKey: "nav.experience" },
	{ href: "/education", labelKey: "nav.education" },
	{ href: "/blog", labelKey: "nav.blog" },
	{ href: "/contact", labelKey: "nav.contact" },
];

const normalizePath = (path: string) =>
	path === "/" ? "/" : path.replace(/\/$/, "");

const withLocale = (href: string, loc: Locale) => {
	if (href.startsWith("/en") || href.startsWith("/es")) return href;
	return href === "/" ? `/${loc}` : `/${loc}${href}`;
};

const stripLocalePrefix = (pathname: string) =>
	pathname.replace(/^\/(en|es)(?=\/|$)/, "") || "/";

const currentPath = stripLocalePrefix(Astro.url.pathname);
const normalizedCurrent = normalizePath(currentPath);
---

<header
	class="sticky top-0 z-50 border-b border-slate-200/70 bg-white/70 backdrop-blur-md dark:border-zinc-800/60 dark:bg-zinc-900/70"
>
	<div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-5">
		<a
			href={withLocale("/", locale)}
			class="text-sm font-semibold tracking-widest text-slate-900 transition-colors hover:text-purple-700 dark:text-zinc-100 dark:hover:text-purple-200"
		>
			JMF
		</a>

		<nav class="hidden items-center gap-6 text-sm md:flex">
			{
				links.map((link) => {
					const active = normalizedCurrent === link.href;
					return (
						<a
							href={withLocale(link.href, locale)}
							class={`transition-colors ${
								active
									? "text-purple-700 dark:text-purple-300"
									: "text-slate-600 hover:text-slate-900 dark:text-zinc-400 dark:hover:text-purple-200"
							}`}
						>
							{t(locale, link.labelKey)}
						</a>
					);
				})
			}

			<LanguageToggle locale={locale} />
			<ThemeToggle locale={locale} />
		</nav>

		<div class="flex items-center gap-3 md:hidden">
			<LanguageToggle locale={locale} />
			<ThemeToggle locale={locale} />

			<button
				id="menu-open"
				aria-label={t(locale, "header.openMenu")}
				class="rounded-xl p-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-zinc-300 dark:hover:bg-zinc-800/40 dark:hover:text-zinc-50"
				type="button"
			>
				<Icon name="menu" class="h-6 w-6" />
			</button>
		</div>
	</div>
</header>

<div
	id="mobile-menu"
	class="fixed inset-0 z-50 hidden md:hidden"
	aria-hidden="true"
>
	<div
		id="menu-overlay"
		class="absolute inset-0 bg-black/40 opacity-0 backdrop-blur-sm transition-opacity duration-200"
	>
	</div>

	<aside
		id="menu-panel"
		class="absolute top-0 right-0 h-full w-72 translate-x-full transform border-l border-slate-200/70 bg-white/90 p-6 backdrop-blur transition-transform duration-250 ease-out dark:border-zinc-800/60 dark:bg-zinc-900/85"
		aria-label={t(locale, "header.mobileNav")}
	>
		<div class="mb-8 flex items-center justify-between">
			<span
				class="text-sm font-semibold tracking-widest text-slate-900 dark:text-zinc-100"
			>
				JMF
			</span>

			<button
				id="menu-close"
				aria-label={t(locale, "header.closeMenu")}
				class="rounded-xl p-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-zinc-300 dark:hover:bg-zinc-800/40 dark:hover:text-zinc-50"
				type="button"
			>
				<Icon name="x" class="h-6 w-6" />
			</button>
		</div>

		<nav class="flex flex-col gap-3">
			{
				links.map((link) => {
					const active = normalizedCurrent === link.href;
					return (
						<a
							href={withLocale(link.href, locale)}
							class={`rounded-2xl border px-4 py-3 text-sm font-semibold transition ${
								active
									? "border-purple-500/25 bg-purple-500/10 text-purple-700 dark:border-purple-500/25 dark:text-purple-300"
									: "border-slate-200/80 bg-white/60 text-slate-700 hover:border-purple-500/25 hover:text-purple-700 dark:border-zinc-800/70 dark:bg-zinc-950/25 dark:text-zinc-300 dark:hover:border-purple-500/30 dark:hover:text-purple-200"
							}`}
							data-close-menu
						>
							{t(locale, link.labelKey)}
						</a>
					);
				})
			}
		</nav>
	</aside>
</div>

<script is:inline>
	(() => {
		/* Lang toggle */
		document.querySelectorAll("a[data-lang]").forEach((el) => {
			el.addEventListener("click", () => {
				const lang = el.getAttribute("data-lang");
				if (lang !== "en" && lang !== "es") return;

				try {
					localStorage.setItem("lang", lang);
				} catch {}
			});
		});

		/* Theme toggle */
		const buttons = document.querySelectorAll("button.theme-toggle");
		if (!buttons.length) return;

		const isDark = () => document.documentElement.classList.contains("dark");

		const syncButton = (btn) => {
			const sun = btn.querySelector('[data-theme-icon="sun"]');
			const moon = btn.querySelector('[data-theme-icon="moon"]');
			if (!sun || !moon) return;

			const dark = isDark();

			sun.classList.toggle("hidden", !dark);
			moon.classList.toggle("hidden", dark);

			const darkLabel =
				btn.getAttribute("data-label-light") || "Switch to light mode";
			const lightLabel =
				btn.getAttribute("data-label-dark") || "Switch to dark mode";

			btn.setAttribute("aria-label", dark ? darkLabel : lightLabel);
		};

		const syncAll = () => buttons.forEach(syncButton);

		syncAll();

		buttons.forEach((btn) => {
			btn.addEventListener("click", () => {
				const nextIsDark = !isDark();
				document.documentElement.classList.toggle("dark", nextIsDark);
				localStorage.setItem("theme", nextIsDark ? "dark" : "light");
				syncAll();
			});
		});

		/* Mobile menu (tu cÃ³digo igual) */
		const openBtn = document.getElementById("menu-open");
		const root = document.getElementById("mobile-menu");
		const overlay = document.getElementById("menu-overlay");
		const panel = document.getElementById("menu-panel");
		const closeBtn = document.getElementById("menu-close");

		if (!openBtn || !root || !overlay || !panel) return;

		const DURATION = 250;

		const openMenu = () => {
			root.classList.remove("hidden");
			root.setAttribute("aria-hidden", "false");

			requestAnimationFrame(() => {
				overlay.classList.add("opacity-100");
				overlay.classList.remove("opacity-0");

				panel.classList.remove("translate-x-full");
				panel.classList.add("translate-x-0");
			});
		};

		const closeMenu = () => {
			overlay.classList.remove("opacity-100");
			overlay.classList.add("opacity-0");

			panel.classList.remove("translate-x-0");
			panel.classList.add("translate-x-full");

			window.setTimeout(() => {
				root.classList.add("hidden");
				root.setAttribute("aria-hidden", "true");
			}, DURATION);
		};

		openBtn.addEventListener("click", openMenu);
		closeBtn?.addEventListener("click", closeMenu);
		overlay.addEventListener("click", closeMenu);

		root.querySelectorAll("[data-close-menu]").forEach((el) => {
			el.addEventListener("click", closeMenu);
		});

		window.addEventListener("keydown", (e) => {
			if (e.key === "Escape" && !root.classList.contains("hidden")) closeMenu();
		});
	})();
</script>
